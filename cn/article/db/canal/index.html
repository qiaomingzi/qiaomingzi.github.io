<!doctype html><html class=no-js lang=cn>
<head>
<meta charset=utf-8>
<link rel=preload href=https://qiaomingzi.github.io/fonts/muli-latin-200.woff2 as=font type=font/woff2 crossorigin>
<link rel=preload href=https://qiaomingzi.github.io/fonts/muli-latin-400.woff2 as=font type=font/woff2 crossorigin>
<link rel=preload href=https://qiaomingzi.github.io/fonts/muli-latin-800.woff2 as=font type=font/woff2 crossorigin>
<meta http-equiv=X-UA-Compatible content="IE=edge">
<title>
canal-mysql binlog日志解析 | 李明梓
</title>
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=generator content="Hugo 0.125.0">
<meta name=robots content="index, follow">
<link rel=stylesheet href=/output/css/app.min.f5631eeeca4e467026e4115898af115d1dda1767791c22841d02b8a556b2ad5c.css integrity="sha256-9WMe7spORnAm5BFYmK8RXR3aF2d5HCKEHQK4pVayrVw=" crossorigin=anonymous>
<meta name=description content="
        李明梓个人站点
      
      ">
<script type=text/javascript src=/output/js/app.d805ae0639aa4bf4b35f1863e219243d6a79b910625d8f0be3664db006b4ce6f.js integrity="sha256-2AWuBjmqS/SzXxhj4hkkPWp5uRBiXY8L42ZNsAa0zm8=" crossorigin=anonymous defer></script>
<script async defer src=https://buttons.github.io/buttons.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png href=/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicon-16x16.png sizes=16x16>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#0594cb>
<meta name=theme-color content="#ffffff">
<meta property="og:title" content="canal-mysql binlog日志解析">
<meta property="og:description" content="1.参考 【alibaba canal】https://github.com/alibaba/canal
【mysql binlog】https://dev.mysql.com/doc/refman/8.0/en/binary-log.html
【mysql event】https://dev.mysql.com/doc/internals/en/event-meanings.html
【mysqlbinlog 命令】https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html
2.基本简介 canal [kə&rsquo;næl]，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费
2.1 mysql主备复制实现 master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events，可以通过show binlog events进行查看）； slave将master的binary log events拷贝到它的中继日志(relay log)； slave重做中继日志中的事件，将改变反映它自己的数据。 2.2 mysql binglog 数据包格式 mysql 事件体目前有一下版本
v1：在 MySQL 3.23 中使用
+=====================================+ | event | timestamp 0 : 4 | | header +----------------------------+ | | type_code 4 : 1 | | +----------------------------+ | | server_id 5 : 4 | | +----------------------------+ | | event_length 9 : 4 | +=====================================+ | event | fixed part 13 : y | | data +----------------------------+ | | variable part | +=====================================+ 标头长度 = 13 字节 数据长度 = (event_length - 13) 字节 y 特定于事件类型。 v3：在 MySQL 4.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://qiaomingzi.github.io/cn/article/db/canal/"><meta property="og:image" content="https://qiaomingzi.github.io/opengraph/gohugoio-card-base-1_huf001e7df4fd9c00c4355abac7d4ca455_242906_filter_14885915122682527418.png"><meta property="article:section" content="cn">
<meta property="article:published_time" content="2021-10-16T15:42:33+08:00">
<meta property="article:modified_time" content="2024-04-18T09:21:33+08:00">
<meta itemprop=name content="canal-mysql binlog日志解析">
<meta itemprop=description content="1.参考 【alibaba canal】https://github.com/alibaba/canal
【mysql binlog】https://dev.mysql.com/doc/refman/8.0/en/binary-log.html
【mysql event】https://dev.mysql.com/doc/internals/en/event-meanings.html
【mysqlbinlog 命令】https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html
2.基本简介 canal [kə&rsquo;næl]，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费
2.1 mysql主备复制实现 master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events，可以通过show binlog events进行查看）； slave将master的binary log events拷贝到它的中继日志(relay log)； slave重做中继日志中的事件，将改变反映它自己的数据。 2.2 mysql binglog 数据包格式 mysql 事件体目前有一下版本
v1：在 MySQL 3.23 中使用
+=====================================+ | event | timestamp 0 : 4 | | header +----------------------------+ | | type_code 4 : 1 | | +----------------------------+ | | server_id 5 : 4 | | +----------------------------+ | | event_length 9 : 4 | +=====================================+ | event | fixed part 13 : y | | data +----------------------------+ | | variable part | +=====================================+ 标头长度 = 13 字节 数据长度 = (event_length - 13) 字节 y 特定于事件类型。 v3：在 MySQL 4.">
<meta itemprop=datePublished content="2021-10-16T15:42:33+08:00">
<meta itemprop=dateModified content="2024-04-18T09:21:33+08:00">
<meta itemprop=wordCount content="1036">
<meta itemprop=image content="https://qiaomingzi.github.io/images/gohugoio-card.png">
<meta itemprop=keywords content="Java"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://qiaomingzi.github.io/opengraph/gohugoio-card-base-1_huf001e7df4fd9c00c4355abac7d4ca455_242906_filter_14885915122682527418.png">
<meta name=twitter:title content="canal-mysql binlog日志解析">
<meta name=twitter:description content="1.参考 【alibaba canal】https://github.com/alibaba/canal
【mysql binlog】https://dev.mysql.com/doc/refman/8.0/en/binary-log.html
【mysql event】https://dev.mysql.com/doc/internals/en/event-meanings.html
【mysqlbinlog 命令】https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html
2.基本简介 canal [kə&rsquo;næl]，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费
2.1 mysql主备复制实现 master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events，可以通过show binlog events进行查看）； slave将master的binary log events拷贝到它的中继日志(relay log)； slave重做中继日志中的事件，将改变反映它自己的数据。 2.2 mysql binglog 数据包格式 mysql 事件体目前有一下版本
v1：在 MySQL 3.23 中使用
+=====================================+ | event | timestamp 0 : 4 | | header +----------------------------+ | | type_code 4 : 1 | | +----------------------------+ | | server_id 5 : 4 | | +----------------------------+ | | event_length 9 : 4 | +=====================================+ | event | fixed part 13 : y | | data +----------------------------+ | | variable part | +=====================================+ 标头长度 = 13 字节 数据长度 = (event_length - 13) 字节 y 特定于事件类型。 v3：在 MySQL 4.">
<script async src="https://www.googletagmanager.com/gtag/js?id=245212315af876cae36fd6880abbfa41"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","245212315af876cae36fd6880abbfa41",{anonymize_ip:!0,dimension1:"qiaomingzi.github.io",dimension2:""});var trackOutboundLink=function(e){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon"})}</script>
</head>
<body class="ma0 sans-serif bg-primary-color-light">
<nav class="bg-primary-color-dark pv4 w-100" role=navigation>
<div class="center flex-ns flex-wrap items-center justify-start mw9">
<h1 class="dim f3 lh-solid ml0-ns mr0 mr4-l mv0 pl3 pl4-ns">
<a href=javascript:void(0); class="link white">
李明梓
</a>
</h1>
<div class="db dib-ns pl3"><form id=site-search-form role=search>
<fieldset class="bn ma0 pa0">
<label class=clip for=search-input>Search</label>
<input type=search id=search-input class="needs-js bg-left bn f5 input-reset lh-solid mt3 mt0-ns pl4 pv2 w5 white" placeholder="Search the Docs" name=search-input style="background:url(/images/icon-search.png)5px 11px/16px 16px no-repeat;background-color:rgba(255,255,255,0)">
</fieldset>
</form>
</div>
<ul class="list ma0 pa0 dn dib-l" role=menu>
<li class="f5 dib mr4" role=menuitem>
<a href=https://qiaomingzi.github.io/ class="dim link light-silver">
首页
</a>
</li>
<li class="f5 dib mr4" role=menuitem>
<a href=/article/documentation/ class="dim link light-silver">
文档
</a>
</li>
<li class="f5 dib mr4" role=menuitem>
<a href=/about/ class="dim link light-silver">
关于我
</a>
</li>
</ul>
<div class="absolute mt1 mt2-l pr3 right-0 top-0 flex items-start">
<a class="github-button needs-js link primary-color-dark" href=https://github.com/qiaomingzi data-size=large data-show-count=false aria-label="Star gohugoio/hugo on GitHub">Star</a>
</div>
</div>
</nav>
<main role=main class="content-with-sidebar min-vh-100 pb7 pb0-ns">
<article class="w-100 ph4 pb5 pb6-ns pt1 pt5-ns">
<div class=flex-l>
<div class="order-0 w-20 dn db-l">
<nav role=navigation>
<ul class="list pa0 nl2">
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.bigdata>bigdata</a>
<ul class="bigdata desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/bigdata/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
bigdata
</a>
</li>
<li class="f6 fw4">
<a href=/article/bigdata/%E8%AF%BB%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%9845%E8%AE%B2/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
读[数据分析实战45讲]
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.go>go</a>
<ul class="go desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/go/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
go
</a>
</li>
<li class="f6 fw4">
<a href=/article/go/go-sdk/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
GO SDK
</a>
</li>
<li class="f6 fw4">
<a href=/article/go/k8s/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
K8S
</a>
</li>
<li class="f6 fw4">
<a href=/article/go/go%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%8336%E8%AE%B2/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
读[GO语言核心36讲]
</a>
</li>
<li class="f6 fw4">
<a href=/article/go/go%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
读[GO语言编程]
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.java>java</a>
<ul class="java desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/java/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
java
</a>
</li>
<li class="f6 fw4">
<a href=/article/java/maven/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
maven-wrapper基础使用
</a>
</li>
<li class="f6 fw4">
<a href=/article/java/%E4%BD%8D%E8%BF%90%E7%AE%97/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
位运算基础知识
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.python>python</a>
<ul class="python desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/python/python%E5%9F%BA%E7%A1%80/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
python基础
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.db>db</a>
<ul class="db desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/db/canal/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
canal-mysql binlog日志解析
</a>
</li>
<li class="f6 fw4">
<a href=/article/db/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
db
</a>
</li>
<li class="f6 fw4">
<a href=/article/db/mysql-master-slave/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
mysql master-slave
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8 mb1 bb b--moon-gray">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.ai>ai</a>
<ul class="ai desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/ai/ai-agent/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
gpt-agent
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.读书>读书</a>
<ul class="读书 desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/%E8%AF%BB%E4%B9%A6/%E5%A4%A7%E9%A3%8E%E6%AD%8C/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
&lt;&lt;大风歌>>王立群
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E8%AF%BB%E4%B9%A6/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
概览
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.工具>工具</a>
<ul class="工具 desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/%E5%B7%A5%E5%85%B7/jemeter/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
jemeter基本使用
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%B7%A5%E5%85%B7/sonarqube/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
sonarqube基础使用
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%B7%A5%E5%85%B7/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
工具
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.数学>数学</a>
<ul class="数学 desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/%E6%95%B0%E5%AD%A6/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
math
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E6%95%B0%E5%AD%A6/%E6%95%B0%E5%AD%A6%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
数学基础概念
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.英语>英语</a>
<ul class="英语 desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/%E8%8B%B1%E8%AF%AD/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
english
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E8%8B%B1%E8%AF%AD/%E8%87%AA%E7%84%B6%E6%8B%BC%E8%AF%BB/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
英语自然拼读
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E8%8B%B1%E8%AF%AD/%E9%9F%B3%E8%8A%82%E5%88%92%E5%88%86/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
英语音节划分
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=javascript:void(0) class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.其他>其他</a>
<ul class="其他 desktopmenu animated fadeIn list pl0 bg-light-gray dn">
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/hexo%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
Hexo基础使用
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/hugo%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
Hugo基本使用
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/markdown%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
Markdown基本使用
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/yarn%E7%9B%B8%E5%85%B3/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
Yarn相关
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/%E5%A3%B0%E5%8D%A1/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
关于调音声卡
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
其他
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/%E5%BC%80%E6%BA%90%E7%9B%91%E6%8E%A7%E8%BD%AF%E4%BB%B6%E5%AF%B9%E6%AF%94_zabbix/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
开源监控软件对比_zabbix
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E7%B4%A2%E5%BC%95/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
开源项目索引
</a>
</li>
<li class="f6 fw4">
<a href=/article/%E5%85%B6%E4%BB%96/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F30%E5%88%86%E9%92%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/ class="db link hover-bg-gray hover-white pl3 pr2 pv2 black">
正则表达式30分钟入门教程
</a>
</li>
</ul>
</li>
<li class="f5 w-100 hover-bg-light-gray hover-accent-color-light fw8">
<a href=/sources/ class="js-toggle dib w-100 link mid-gray hover-accent-color-light pl2 pr2 pv2" data-target=.sources>源码探究</a>
</li>
</ul>
</nav>
</div>
<div class="order-1 flex-grow-1 ph0 ph5-ns mt0-ns mid-gray nested-copy-line-height no-underline nested-links nested-img nested-copy-seperator nested-blockquote">
<div style=max-width:40rem class=documentation-copy>
<div id=readout class="fixed right-0 bottom-0"></div>
<header class="flex-none w-100">
<a href=/categories/java class="f6 fw8 mb0 link mid-gray dim mr3">
JAVA
</a>
<h1 class="lh-title mb3 mv0 pt3 primary-color-dark">
canal-mysql binlog日志解析
</h1>
</header>
<aside class="bt bw1 pt3 mt2 mid-gray b--mid-gray fn w-100">
</aside>
<div class=prose id=prose>
<div class=mb4></div>
<h3 id=1参考>1.参考 <a class=header-link href=#1%e5%8f%82%e8%80%83><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3>
<p>【alibaba canal】https://github.com/alibaba/canal</p>
<p>【mysql binlog】https://dev.mysql.com/doc/refman/8.0/en/binary-log.html</p>
<p>【mysql event】https://dev.mysql.com/doc/internals/en/event-meanings.html</p>
<p>【mysqlbinlog 命令】https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html</p>
<h3 id=2基本简介>2.基本简介 <a class=header-link href=#2%e5%9f%ba%e6%9c%ac%e7%ae%80%e4%bb%8b><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3>
<p><strong>canal [kə&rsquo;næl]</strong>，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费</p>
<p><img src=./images/canal.png></p>
<h4 id=21-mysql主备复制实现>2.1 mysql主备复制实现 <a class=header-link href=#21-mysql%e4%b8%bb%e5%a4%87%e5%a4%8d%e5%88%b6%e5%ae%9e%e7%8e%b0><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<p><img src=./images/mysql_syn.jfif></p>
<ol>
<li>master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events，可以通过show binlog events进行查看）；</li>
<li>slave将master的binary log events拷贝到它的中继日志(relay log)；</li>
<li>slave重做中继日志中的事件，将改变反映它自己的数据。</li>
</ol>
<h4 id=22-mysql-binglog-数据包格式>2.2 mysql binglog 数据包格式 <a class=header-link href=#22-mysql-binglog-%e6%95%b0%e6%8d%ae%e5%8c%85%e6%a0%bc%e5%bc%8f><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<p><img src=./images/binlog_pack.png></p>
<p>mysql 事件体目前有一下版本</p>
<ul>
<li>
<p>v1：在 MySQL 3.23 中使用</p>
<pre tabindex=0><code>+=====================================+
| event  | timestamp         0 : 4    |
| header +----------------------------+
|        | type_code         4 : 1    |
|        +----------------------------+
|        | server_id         5 : 4    |
|        +----------------------------+
|        | event_length      9 : 4    |
+=====================================+
| event  | fixed part       13 : y    |
| data   +----------------------------+
|        | variable part              |
+=====================================+

标头长度 = 13 字节
数据长度 = (event_length - 13) 字节
y 特定于事件类型。
</code></pre></li>
<li>
<p>v3：在 MySQL 4.0.2 到 4.1 中使用</p>
<pre tabindex=0><code>+=====================================+
| event  | timestamp         0 : 4    |
| header +----------------------------+
|        | type_code         4 : 1    |
|        +----------------------------+
|        | server_id         5 : 4    |
|        +----------------------------+
|        | event_length      9 : 4    |
|        +----------------------------+
|        | next_position    13 : 4    |
|        +----------------------------+
|        | flags            17 : 2    |
+=====================================+
| event  | fixed part       19 : y    |
| data   +----------------------------+
|        | variable part              |
+=====================================+

标头长度 = 19 字节
数据长度 = (event_length - 19) 字节
y 特定于事件类型。
</code></pre></li>
<li>
<p>v4：用于 MySQL 5.0 及更高版本</p>
<pre tabindex=0><code>+=====================================+
| event  | timestamp         0 : 4    |
| header +----------------------------+
|        | type_code         4 : 1    |
|        +----------------------------+
|        | server_id         5 : 4    |
|        +----------------------------+
|        | event_length      9 : 4    |
|        +----------------------------+
|        | next_position    13 : 4    |
|        +----------------------------+
|        | flags            17 : 2    |
|        +----------------------------+
|        | extra_headers    19 : x-19 |
+=====================================+
| event  | fixed part        x : y    |
| data   +----------------------------+
|        | variable part              |
+=====================================+

标头长度 = x 字节
数据长度 = (event_length - x) 字节
固定数据长度 = y 字节可变数据长度 = (event_length - (x + y)) 字节
</code></pre></li>
</ul>
<h4 id=22-canal工作原理>2.2 canal工作原理 <a class=header-link href=#22-canal%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<ol>
<li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li>
<li>mysql master收到dump请求，开始推送binary log给slave(也就是canal)</li>
<li>canal解析binary log对象(原始为byte流)</li>
</ol>
<h4 id=23-canal架构>2.3 canal架构 <a class=header-link href=#23-canal%e6%9e%b6%e6%9e%84><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<p><img src=./images/canal_construct.jfif></p>
<p>说明：</p>
<ul>
<li>server代表一个canal运行实例，对应于一个jvm</li>
<li>instance对应于一个数据队列 （1个server对应1..n个instance)</li>
</ul>
<p>instance模块：</p>
<ul>
<li>
<p>eventParser (数据源接入，模拟slave协议和master进行交互，协议解析)</p>
</li>
<li>
<p>eventSink (Parser和Store链接器，进行数据过滤，加工，分发的工作)</p>
</li>
<li>
<p>eventStore (数据存储)</p>
</li>
<li>
<p>metaManager (增量订阅&消费信息管理器)</p>
</li>
</ul>
<h5 id=canal-instance>canal-instance</h5>
<p>instance代表了一个实际运行的数据队列，包括了EventPaser,EventSink,EventStore等组件。</p>
<p>抽象了CanalInstanceGenerator，主要是考虑配置的管理方式：</p>
<ul>
<li>manager方式： 和你自己的内部web console/manager系统进行对接。(目前主要是公司内部使用)</li>
<li>spring方式：基于spring xml + properties进行定义，构建spring配置.</li>
</ul>
<p><img src=./images/canal_instance.jfif></p>
<h5 id=canal-event-parser>canal-event-parser</h5>
<p>整个parser过程大致可分为几步：</p>
<ol>
<li>Connection获取上一次解析成功的位置 (如果第一次启动，则获取初始指定的位置或者是当前数据库的binlog位点)</li>
<li>Connection建立链接，发送BINLOG_DUMP指令
// 0. write command number
// 1. write 4 bytes bin-log position to start at
// 2. write 2 bytes bin-log flags
// 3. write 4 bytes server id of the slave
// 4. write bin-log file name</li>
<li>Mysql开始推送Binaly Log</li>
<li>接收到的Binaly Log的通过Binlog parser进行协议解析，补充一些特定信息
// 补充字段名字，字段类型，主键信息，unsigned类型处理</li>
<li>传递给EventSink模块进行数据存储，是一个阻塞操作，直到存储成功</li>
<li>存储成功后，定时记录Binaly Log位置</li>
</ol>
<p><img src=./images/canal_parse.jfif></p>
<h5 id=canal-event-sink>canal-event-sink</h5>
<p><img src=./images/canal-sink.jfif></p>
<p>说明：</p>
<ul>
<li>数据过滤：支持通配符的过滤模式，表名，字段内容等</li>
<li>数据路由/分发：解决1:n (1个parser对应多个store的模式)</li>
<li>数据归并：解决n:1 (多个parser对应1个store)</li>
<li>数据加工：在进入store之前进行额外的处理，比如join</li>
</ul>
<blockquote>
<p>数据1:n业务</p>
</blockquote>
<blockquote>
<blockquote>
<p>为了合理的利用数据库资源， 一般常见的业务都是按照schema进行隔离，然后在mysql上层或者dao这一层面上，进行一个数据源路由，屏蔽数据库物理位置对开发的影响，阿里系主要是通过cobar/tddl来解决数据源路由问题。</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>所以，一般一个数据库实例上，会部署多个schema，每个schema会有由1个或者多个业务方关注</p>
</blockquote>
</blockquote>
<blockquote>
<p>数据n:1业务</p>
</blockquote>
<blockquote>
<blockquote>
<p>同样，当一个业务的数据规模达到一定的量级后，必然会涉及到水平拆分和垂直拆分的问题，针对这些拆分的数据需要处理时，就需要链接多个store进行处理，消费的位点就会变成多份，而且数据消费的进度无法得到尽可能有序的保证。</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>所以，在一定业务场景下，需要将拆分后的增量数据进行归并处理，比如按照时间戳/全局id进行排序归并.</p>
</blockquote>
</blockquote>
<h5 id=canal-event-store>canal-event-store</h5>
<ul>
<li>目前仅实现了Memory内存模式，后续计划增加本地file存储，mixed混合模式</li>
<li>借鉴了Disruptor的RingBuffer的实现思路</li>
</ul>
<p>RingBuffer设计：</p>
<p><img src=./images/cannal-store.jfif></p>
<p>定义了3个cursor</p>
<ul>
<li>Put : Sink模块进行数据存储的最后一次写入位置</li>
<li>Get : 数据订阅获取的最后一次提取位置</li>
<li>Ack : 数据消费成功的最后一次消费位置</li>
</ul>
<p>借鉴Disruptor的RingBuffer的实现，将RingBuffer拉直来看：
<img alt=img src=./images/cannal-store_1.jfif></p>
<p>实现说明：</p>
<ul>
<li>Put/Get/Ack cursor用于递增，采用long型存储</li>
<li>buffer的get操作，通过取余或者与操作。(与操作： cusor & (size - 1) , size需要为2的指数，效率比较高)</li>
</ul>
<h4 id=24-canal-ha设计>2.4 canal HA设计 <a class=header-link href=#24-canal-ha%e8%ae%be%e8%ae%a1><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<p><img src=./images/canal_ha.jfif></p>
<p>canal的ha分为两部分，canal server和canal client分别有对应的ha实现</p>
<ul>
<li>canal server: 为了减少对mysql dump的请求，不同server上的instance要求同一时间只能有一个处于running，其他的处于standby状态.</li>
<li>canal client: 为了保证有序性，一份instance同一时间只能由一个canal client进行get/ack/rollback操作，否则客户端接收无法保证有序。</li>
</ul>
<p>整个HA机制的控制主要是依赖了zookeeper的几个特性，watcher和EPHEMERAL节点(和session生命周期绑定)。</p>
<p>大致步骤：</p>
<ol>
<li>canal server要启动某个canal instance时都先向zookeeper进行一次尝试启动判断 (实现：创建EPHEMERAL节点，谁创建成功就允许谁启动)</li>
<li>创建zookeeper节点成功后，对应的canal server就启动对应的canal instance，没有创建成功的canal instance就会处于standby状态</li>
<li>一旦zookeeper发现canal server A创建的节点消失后，立即通知其他的canal server再次进行步骤1的操作，重新选出一个canal server启动instance.</li>
<li>canal client每次进行connect时，会首先向zookeeper询问当前是谁启动了canal instance，然后和其建立链接，一旦链接不可用，会重新尝试connect.</li>
</ol>
<p>Canal Client的方式和canal server方式类似，也是利用zookeeper的抢占EPHEMERAL节点的方式进行控制.</p>
<h4 id=25-canal-client>2.5 canal client <a class=header-link href=#25-canal-client><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<h5 id=client-server交互>client-server交互</h5>
<p><img src=./images/canal-protobuf.jfif></p>
<p>get/ack/rollback协议介绍：</p>
<ul>
<li>Message getWithoutAck(int batchSize)，允许指定batchSize，一次可以获取多条，每次返回的对象为Message，包含的内容为：
a. batch id 唯一标识
b. entries 具体的数据对象，对应的数据对象格式：<a href=https://github.com/alibaba/canal/blob/master/protocol/src/main/java/com/alibaba/otter/canal/protocol/EntryProtocol.proto rel=external>EntryProtocol.proto</a></li>
<li>void rollback(long batchId)，顾命思议，回滚上次的get请求，重新获取数据。基于get获取的batchId进行提交，避免误操作</li>
<li>void ack(long batchId)，顾命思议，确认已经消费成功，通知server删除数据。基于get获取的batchId进行提交，避免误操作</li>
</ul>
<p>canal的get/ack/rollback协议和常规的jms协议有所不同，允许get/ack异步处理，比如可以连续调用get多次，后续异步按顺序提交ack/rollback，项目中称之为流式api.</p>
<p>流式api设计的好处：</p>
<ul>
<li>get/ack异步化，减少因ack带来的网络延迟和操作成本 (99%的状态都是处于正常状态，异常的rollback属于个别情况，没必要为个别的case牺牲整个性能)</li>
<li>get获取数据后，业务消费存在瓶颈或者需要多进程/多线程消费时，可以不停的轮询get数据，不停的往后发送任务，提高并行化. (作者在实际业务中的一个case：业务数据消费需要跨中美网络，所以一次操作基本在200ms以上，为了减少延迟，所以需要实施并行化)</li>
</ul>
<p>流式api设计：</p>
<p><img src=./images/canal-stream-api.jfif></p>
<ul>
<li>每次get操作都会在meta中产生一个mark，mark标记会递增，保证运行过程中mark的唯一性</li>
<li>每次的get操作，都会在上一次的mark操作记录的cursor继续往后取，如果mark不存在，则在last ack cursor继续往后取</li>
<li>进行ack时，需要按照mark的顺序进行数序ack，不能跳跃ack. ack会删除当前的mark标记，并将对应的mark位置更新为last ack cusor</li>
<li>一旦出现异常情况，客户端可发起rollback情况，重新置位：删除所有的mark, 清理get请求位置，下次请求会从last ack cursor继续往后取</li>
</ul>
<h5 id=数据对象格式>数据对象格式</h5>
<pre tabindex=0><code>Entry
	Header
		logfileName [binlog文件名]
		logfileOffset [binlog position]
		executeTime [binlog里记录变更发生的时间戳]
		schemaName [数据库实例]
		tableName [表名]
		eventType [insert/update/delete类型]
	entryType 	[事务头BEGIN/事务尾END/数据ROWDATA]
	storeValue 	[byte数据,可展开，对应的类型为RowChange]
	
	
RowChange
  isDdl		[是否是ddl变更操作，比如create table/drop table]
  sql		[具体的ddl sql]
  rowDatas	[具体insert/update/delete的变更数据，可为多条，1个binlog event事件可对应多条变更，比如批处理]
  beforeColumns [Column类型的数组]
  afterColumns [Column类型的数组]


Column
  index		[column序号]
  sqlType		[jdbc type]
  name		[column name]
  isKey		[是否为主键]
  updated		[是否发生过变更]
  isNull		[值是否为null]
  value		[具体的内容，注意为文本]
</code></pre><p>说明：</p>
<ul>
<li>可以提供数据库变更前和变更后的字段内容，针对binlog中没有的name,isKey等信息进行补全</li>
<li>可以提供ddl的变更语句</li>
</ul>
<h3 id=3cannel-源码>3.cannel 源码 <a class=header-link href=#3cannel-%e6%ba%90%e7%a0%81><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3>
<h4 id=31-canal启动>3.1 canal启动 <a class=header-link href=#31-canal%e5%90%af%e5%8a%a8><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<pre tabindex=0><code>public void start() {
        super.start();

        if (!embeddedServer.isStart()) {
            embeddedServer.start();
        }
        //1.创建canal server
        this.bootstrap = new ServerBootstrap(new NioServerSocketChannelFactory(Executors.newCachedThreadPool(),
            Executors.newCachedThreadPool()));
        bootstrap.setOption(&#34;child.keepAlive&#34;, true);
        bootstrap.setOption(&#34;child.tcpNoDelay&#34;, true);

        //2.构造对应的pipeline
        bootstrap.setPipelineFactory(() -&gt; {
            ChannelPipeline pipelines = Channels.pipeline();
            pipelines.addLast(FixedHeaderFrameDecoder.class.getName(), new FixedHeaderFrameDecoder());
            // support to maintain child socket channel.
            pipelines.addLast(HandshakeInitializationHandler.class.getName(),
                new HandshakeInitializationHandler(childGroups));
            pipelines.addLast(ClientAuthenticationHandler.class.getName(),
                new ClientAuthenticationHandler(embeddedServer));
            //会话处理
            SessionHandler sessionHandler = new SessionHandler(embeddedServer);
            pipelines.addLast(SessionHandler.class.getName(), sessionHandler);
            return pipelines;
        });

        //3.启动 默认监听1111端口
        if (StringUtils.isNotEmpty(ip)) {
            this.serverChannel = bootstrap.bind(new InetSocketAddress(this.ip, this.port));
        } else {
            this.serverChannel = bootstrap.bind(new InetSocketAddress(this.port));
        }
    }
</code></pre><pre tabindex=0><code>  public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {
        ChannelBuffer buffer = (ChannelBuffer) e.getMessage();
        Packet packet = Packet.parseFrom(buffer.readBytes(buffer.readableBytes()).array());
        ClientIdentity clientIdentity = null;
       
            switch (packet.getType()) {
                case SUBSCRIPTION:
                    
                    break;
                case UNSUBSCRIPTION:
                     
                    break;
                case GET:
                    
                    break;
                case CLIENTACK:
                
                    break;
                case CLIENTROLLBACK:
                     
                    break;
                default:
                   
                    break;
            }
    }
</code></pre><h4 id=32-client代码>3.2 client代码 <a class=header-link href=#32-client%e4%bb%a3%e7%a0%81><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4>
<p><img src=./images/client_src.png></p>
<h5 id=321-订阅数据-socket>3.2.1 订阅数据-socket</h5>
<pre tabindex=0><code>public static void main(String args[]) {
    // 创建链接
    CanalConnector connector = CanalConnectors.newSingleConnector(new InetSocketAddress(AddressUtils.getHostIp(),11111), &#34;example&#34;, &#34;&#34;, &#34;&#34;);
    int batchSize = 1000; 
    try {
        connector.connect();
        connector.subscribe(&#34;.*\\..*&#34;);
        connector.rollback(); 
        while (isRunning) {
             // 获取指定数量的数据
            Message message = connector.getWithoutAck(batchSize);
            long batchId = message.getId();
            int size = message.getEntries().size();
            if(size &gt; 0){
              printEntry(batchId,message.getEntries());
            }
            // 提交确认
            connector.ack(batchId); 
            // 处理失败, 回滚数据
            // connector.rollback(batchId); 
        }
    } finally {
        connector.disconnect();
    }
}

private static void printEntry(long batchId,List&lt;Entry&gt; entrys) {
    for (Entry entry : entrys) {
        if (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) {
            continue;
        }
        //数据反序列化
        RowChange  rowChage = RowChange.parseFrom(entry.getStoreValue());
        EventType eventType = rowChage.getEventType();
        for (RowData rowData : rowChage.getRowDatasList()) {
            if (eventType == EventType.DELETE) {
                printColumn(rowData.getBeforeColumnsList());
            } else if (eventType == EventType.INSERT) {
                printColumn(rowData.getAfterColumnsList());
            } else {
                System.out.println(&#34;-------&amp;gt; before&#34;);
                printColumn(rowData.getBeforeColumnsList());
                System.out.println(&#34;-------&amp;gt; after&#34;);
                printColumn(rowData.getAfterColumnsList());
            }
        }
    }
}

private static void printColumn(List&lt;Column&gt; columns) {
    for (Column column : columns) {
        System.out.println(column.getName() + &#34; : &#34; + column.getValue() + &#34;    update=&#34; + column.getUpdated());
    }
}
</code></pre><h5 id=322-连接canal-server>3.2.2 连接canal server</h5>
<pre tabindex=0><code>private InetSocketAddress doConnect() throws CanalClientException {
        try {
            channel = SocketChannel.open();
            channel.socket().setSoTimeout(soTimeout);
            SocketAddress address = getAddress();
            if (address == null) {
                address = getNextAddress();
            }
            //1.连接 server
            channel.connect(address);
            //读channel
            readableChannel = Channels.newChannel(channel.socket().getInputStream());
            //写channel
            writableChannel = Channels.newChannel(channel.socket().getOutputStream());
            //2.握手
            Packet p = Packet.parseFrom(readNextPacket());
            if (p.getVersion() != 1) {
                throw new CanalClientException(&#34;unsupported version at this client.&#34;);
            }

            if (p.getType() != PacketType.HANDSHAKE) {
                throw new CanalClientException(&#34;expect handshake but found other type.&#34;);
            }
            Handshake handshake = Handshake.parseFrom(p.getBody());
            supportedCompressions.add(handshake.getSupportedCompressions());
            //
            ByteString seed = handshake.getSeeds(); // seed for auth
            String newPasswd = password;
            if (password != null) {
                // encode passwd
                newPasswd = SecurityUtil.byte2HexStr(SecurityUtil.scramble411(password.getBytes(), seed.toByteArray()));
            }

            ClientAuth ca = ClientAuth.newBuilder()
                .setUsername(username != null ? username : &#34;&#34;)
                .setPassword(ByteString.copyFromUtf8(newPasswd != null ? newPasswd : &#34;&#34;))
                .setNetReadTimeout(idleTimeout)
                .setNetWriteTimeout(idleTimeout)
                .build();
            //3.鉴权客户端
            writeWithHeader(Packet.newBuilder()
                .setType(PacketType.CLIENTAUTHENTICATION)
                .setBody(ca.toByteString())
                .build()
                .toByteArray());
            //4.连接成确认
            Packet ack = Packet.parseFrom(readNextPacket());
            if (ack.getType() != PacketType.ACK) {
                throw new CanalClientException(&#34;unexpected packet type when ack is expected&#34;);
            }

            Ack ackBody = Ack.parseFrom(ack.getBody());
            if (ackBody.getErrorCode() &gt; 0) {
                throw new CanalClientException(&#34;something goes wrong when doing authentication: &#34;
                                               + ackBody.getErrorMessage());
            }

            connected = true;
            return new InetSocketAddress(channel.socket().getLocalAddress(), channel.socket().getLocalPort());
        } catch (IOException | NoSuchAlgorithmException e) {
            throw new CanalClientException(e);
        }
    }
</code></pre>
</div>
<h2>See also</h2>
<ul>
<li><a href=/article/db/canal/>canal-mysql binlog日志解析</a></li>
<li><a href=/article/db/mysql-master-slave/>mysql master-slave</a></li>
<li><a href=/cn/article/db/mysql-master-slave/>mysql master-slave</a></li>
</ul>
</div>
</div>
<div id=right-sidebar class="order-2 w-20 dn db-l sticky pt2">
<aside class="right-0 f6 pv4 pv0-ns ph4-l nested-list-reset nested-copy-line-height">
<div class=nested-links>
<div date-pref>
<a href=https://qiaomingzi.github.io/cn/article/db/mysql-master-slave/ class="dib f6 pr1 hover-bg-light-gray br-100" title="mysql master-slave">
<svg class="fill-current" height="30" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
</a>
</div>
</div>
</aside>
</div>
</div>
</article>
<div id=page-footer class="w-100 bg-light-gray">
<div class="mw7 pa4 center nested-lh-copy lh-copy">
<h6 class="f6 dark-gray mb2">
Last updated: April 18, 2024: <a class="hide-child link primary-color" href=https://github.com/gohugoio/hugoDocs/commit/44b18b5b28284ef645365b4281ed4a498895eda7>chore:temp submit (44b18b5)</a>
</h6>
<a href=https://github.com/gohugoio/hugoDocs/edit/master/content/cn/cn/article/DB/canal/index.md class="f6 ph3 pv1 br2 dib tc ttu mv3 bg-primary-color white hover-bg-green link">Improve this page</a>
</div>
</div>
</main>
<footer class="bg-primary-color-dark ph4-ns pt4 relative w-100" role=contentinfo>
<div class="center flex-ns flex-wrap justify-between mw9 w-90">
<div class="pb3 pt4 w-100 w-50-ns">
<div class="b f3 light-gray mb3 nested-links tc">
李明梓-BLOG<br>
</div>
<div class="center w4">
<img src=/images/hugo-logo-wide.svg alt="Hugo Logo">
</div>
</div>
<div class="w-100 w-50-l light-gray"> 
本文仅为个人笔记,作为学习使用,如有雷同请联系作者 mingzi.li 处理,mail: qiaomingzi100@sina.com
</div>
</div>
</footer>
</body>
</html>