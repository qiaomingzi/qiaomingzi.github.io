<!doctype html><html lang=en><head><meta charset=utf-8><meta name=referrer content="no-referrer"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>canal-mysql binlog日志解析 | mingzi.li blog</title><meta property="og:type" content="website"><meta property="og:title" content="canal-mysql binlog日志解析"><meta property="og:url" content="http://qiaomingzi.github.io/canal-mysql-binlog%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90/"><meta property="og:locale" content="en_GB"><meta property="og:image" content="http://qiaomingzi.github.io/images/og-image.png"><link rel=canonical href=http://qiaomingzi.github.io/canal-mysql-binlog%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90/><meta name=twitter:card content="summary"><meta name=twitter:site content="@p4lm"><link rel=stylesheet type=text/css href=/styles/main-bundle.108386b285ad502399f3a8ab890a333c177e59d922733a408892e466a7a87f70d143ace3585f247b62a75a780bd7bcff68b60fc6760b5ae1414e52c78fe708e7.css integrity media="screen, tv, projection"><link rel=stylesheet type=text/css href=/styles/print-bundle.f3d1ea3e2e864e24f7a26ff871aef6875b8e6246aad31fa6e63fdc9c91c629f6b4cdd7dca9beb3949f8b61a0db4c6fe8ec1bfc44ccf3a2cd9a91ea8e9eb20d44.css integrity media=print><link rel=preload as=font href=/fonts/muli1.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/muli2.woff2 type=font/woff2 crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#04396c><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.83.1"><svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="icon-arrow-right" viewBox="0 0 32 32"><path d="M19.414 27.414l10-10c.781-.781.781-2.047.0-2.828l-10-10c-.781-.781-2.047-.781-2.828.0s-.781 2.047.0 2.828L23.172 14H4c-1.105.0-2 .895-2 2s.895 2 2 2h19.172l-6.586 6.586c-.39.39-.586.902-.586 1.414s.195 1.024.586 1.414c.781.781 2.047.781 2.828.0z"/></symbol><symbol id="icon-arrow-left" viewBox="0 0 32 32"><path d="M12.586 27.414l-10-10c-.781-.781-.781-2.047.0-2.828l10-10c.781-.781 2.047-.781 2.828.0s.781 2.047.0 2.828L8.828 14H28c1.105.0 2 .895 2 2s-.895 2-2 2H8.828l6.586 6.586c.39.39.586.902.586 1.414s-.195 1.024-.586 1.414c-.781.781-2.047.781-2.828.0z"/></symbol><symbol id="icon-calendar" viewBox="0 0 32 32"><path d="M27.2 4.8h-1.6V8h-4.8V4.8h-9.6V8H6.4V4.8H4.8C3.038 4.8 1.6 6.24 1.6 8v19.2c0 1.76 1.438 3.2 3.2 3.2h22.4c1.76.0 3.2-1.44 3.2-3.2V8c0-1.76-1.44-3.2-3.2-3.2zm0 22.4H4.8V14.4h22.4v12.8zM10.4 1.6H7.2v5.6h3.2V1.6zm14.4.0h-3.2v5.6h3.2V1.6z"/></symbol><symbol id="icon-expand" viewBox="0 0 32 32"><path d="M11.179 17.579l-4.69 4.85-3.29-3.886v10.258h10.219l-3.888-3.33 4.848-4.691-3.2-3.2zM18.581 3.2l3.888 3.33-4.848 4.691 3.2 3.2 4.69-4.85 3.29 3.886V3.199H18.582z"/></symbol><symbol id="icon-collapse" viewBox="0 0 32 32"><path d="M6.56 22.56 1.6 27.2l3.2 3.2 4.64-4.96 3.36 3.36v-9.6H3.2l3.36 3.36zM30.4 4.8l-3.2-3.2-4.64 4.96L19.2 3.2v9.6h9.6l-3.36-3.36L30.4 4.8z"/></symbol><symbol id="icon-bubble" viewBox="0 0 32 32"><path d="M16 2c8.837.0 16 5.82 16 13s-7.163 13-16 13c-.849.0-1.682-.054-2.495-.158C10.068 31.279 5.966 31.895 2 31.986v-.841C4.142 30.096 6 28.184 6 26c0-.305-.024-.604-.068-.897-3.619-2.383-5.932-6.024-5.932-10.103.0-7.18 7.163-13 16-13z"/></symbol><symbol id="icon-folder" viewBox="0 0 32 32"><path d="M29.448 7.678C29.27 6.974 28.4 6.4 27.512 6.4H16.61c-.886.0-2.128-.509-2.755-1.131l-.954-.941c-.627-.622-1.867-1.128-2.754-1.128H4.939c-.888.0-1.694.715-1.792 1.59L2.68 9.6h27.09l-.322-1.922zM31.059 11.2h-30.118c-.547.0-.976.47-.923 1.016l1.477 15.47c.059.63.59 1.114 1.226 1.114h26.56c.635.0 1.165-.483 1.226-1.114l1.477-15.47c.053-.546-.376-1.016-.923-1.016z"/></symbol><symbol id="icon-tag" viewBox="0 0 32 32"><path d="M31.021.648c-.178-.502-.726-.768-1.23-.594s-.77.728-.595 1.232c1.486 4.272-1.464 7.462-3.714 9.171l-.909-1.302c-.306-.437-.989-.8-1.52-.806l-5.101.022c-.531-.01-1.32.234-1.755.541l-15.03 10.539c-.728.512-.904 1.515-.395 2.246l6.83 9.773c.512.728 1.33.64 2.059.131l15.03-10.541c.432-.306.931-.965 1.107-1.469l1.597-5.032c.176-.502.069-1.269-.237-1.706l-.554-.794c3.021-2.315 6.157-6.406 4.416-11.413zM24.027 15.621c-1.163.816-2.77.531-3.584-.634-.818-1.168-.533-2.774.632-3.594.925-.648 2.125-.602 2.989.027-.435.262-.734.416-.79.44-.482.229-.688.806-.461 1.288.166.35.514.557.875.557.138.0.278-.032.411-.094.31-.147.643-.322.99-.528.155.95-.222 1.947-1.062 2.538z"/></symbol><symbol id="icon-circle-with-cross" viewBox="0 0 32 32"><title>Close (Esc)</title><path d="M16 2.56C8.578 2.56 2.56 8.578 2.56 16S8.578 29.44 16 29.44 29.44 23.422 29.44 16 23.422 2.56 16 2.56zm7.662 18.338-2.766 2.766L16 18.766l-4.898 4.896-2.766-2.766L13.235 16l-4.898-4.898 2.766-2.765 4.896 4.896 4.898-4.898 2.766 2.766-4.899 4.898 4.898 4.898z"/></symbol></defs></svg></head><body x-data=window.blog :class="{ 'modal-open': isModalOpen, 'keyboard-navigation' : keyboardNavigation }" @mouseup="keyboardNavigation = false" @keydown.tab="keyboardNavigation = true" @keydown.escape=closeModals()><script>try{const a=window.localStorage.getItem('theme');a==='dark'&&document.querySelector('body').classList.add('dark'),a==='light'&&document.querySelector('body').classList.add('light')}catch(a){}</script><link rel=stylesheet type=text/css href=/styles/post-bundle.min.a3c415b51dea409e064708f705f91702ddddb4aaf1c7522073113ac5c6941f198ce5f39ea63cfaf21674b905146c1bdf3eeb0eaa41d22b9d013117c9bb72d81e.css integrity="sha512-o8QVtR3qQJ4GRwj3BfkXAt3dtKrxx1IgcxE6xcaUHxmM5fOepjz68hZ0uQUUbBvfPusOqkHSK50BMRfJu3LYHg==" media="screen, tv, projection"><div id=page-wrapper><header><svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="icon-home" viewBox="0 0 32 32"><path d="M32 18.451 16 6.031.0 18.451v-5.064l16-12.42 16 12.42zM28 18v12h-8v-8h-8v8H4V18l12-9z"/></symbol><symbol id="icon-user" viewBox="0 0 32 32"><path d="M18 22.082v-1.649c2.203-1.241 4-4.337 4-7.432.0-4.971.0-9-6-9s-6 4.029-6 9c0 3.096 1.797 6.191 4 7.432v1.649C7.216 22.637 2 25.97 2 30h28c0-4.03-5.216-7.364-12-7.918z"/></symbol><symbol id="icon-search" viewBox="0 0 32 32"><path d="M31.008 27.231l-7.58-6.447c-.784-.705-1.622-1.029-2.299-.998 1.789-2.096 2.87-4.815 2.87-7.787.0-6.627-5.373-12-12-12s-12 5.373-12 12 5.373 12 12 12c2.972.0 5.691-1.081 7.787-2.87-.031.677.293 1.515.998 2.299l6.447 7.58c1.104 1.226 2.907 1.33 4.007.23s.997-2.903-.23-4.007zM12 20c-4.418.0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8z"/></symbol></defs></svg><div class=header-content @click.away=menu.close()><div class=site-title>mingzi.li blog<span style=font-size:.5rem;margin-top:20px>&nbsp;&nbsp;行到水穷处，坐看风云起</span></div><div class=theme-switcher :class="{'has-javascript': true}"><div class=switch><input type=checkbox name=toggle id=theme-switcher-indicator aria-label="Switch theme" @click=theme.toggleChanged($event.target) checked>
<label for=theme-switcher-indicator><i></i></label>
<span></span></div></div><a href=#content id=skip-link class=skip-link @click.prevent=skipLink.skipToContent($refs.content) @click.away=skipLink.removeContentTabIndex($refs.content)>Skip to content</a>
<button @click=menu.toggle() class=hamburger-trigger>Menu<div class=hamburger-menu><div class=bar :class="{'animate': menu.hamburgerIsOpen()}"></div></div></button><nav :class="{'open': menu.isOpen() || menu.isOpening(), 'open closing': menu.isClosing()}"><a href=/ class=home><svg class="icon icon-home"><use xlink:href="#icon-home"/></svg>首页</a>
<a href=/about/ class=about><svg class="icon icon-user"><use xlink:href="#icon-user"/></svg>关于我</a>
<a href=/search-requires-javascript/ rel=nofollow class=search x-ref=searchMenuLink @click.prevent="menu.close(); search.open();$nextTick(() => $refs.searchInput.focus())"><svg class="icon icon-search"><use xlink:href="#icon-search"/></svg>搜索</a></nav></div></header><div class=body><div class=body-max-width><main id=content x-ref=content><article class=full-article><h1>canal-mysql binlog日志解析</h1><div class=entry-meta><time class=published datetime="2021-10-16 15:42:33 +0000 UTC"><svg class="icon icon-calendar"><use xlink:href="#icon-calendar"/></svg>2021 October 16</time></div><div style=text-align:center;display:block;color:#999><div>本文仅为个人笔记,作为学习使用,如有雷同请联系作者 mingzi.li 处理,mail: qiaomingzi100@sina.com</div></div><h3 id=1参考>1.参考</h3><p>【alibaba canal】https://github.com/alibaba/canal</p><p>【mysql binlog】https://dev.mysql.com/doc/refman/8.0/en/binary-log.html</p><p>【mysql event】https://dev.mysql.com/doc/internals/en/event-meanings.html</p><p>【mysqlbinlog 命令】https://dev.mysql.com/doc/refman/8.0/en/mysqlbinlog.html</p><h3 id=2基本简介>2.基本简介</h3><p><strong>canal [kə&rsquo;næl]</strong>，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费</p><p><img src=./images/canal.png alt></p><h4 id=21-mysql主备复制实现>2.1 mysql主备复制实现</h4><p><img src=./images/mysql_syn.jfif alt></p><ol><li>master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events，可以通过show binlog events进行查看）；</li><li>slave将master的binary log events拷贝到它的中继日志(relay log)；</li><li>slave重做中继日志中的事件，将改变反映它自己的数据。</li></ol><h4 id=22-mysql-binglog-数据包格式>2.2 mysql binglog 数据包格式</h4><p><img src=./images/binlog_pack.png alt></p><p>mysql 事件体目前有一下版本</p><ul><li><p>v1：在 MySQL 3.23 中使用</p><pre><code>+=====================================+
| event  | timestamp         0 : 4    |
| header +----------------------------+
|        | type_code         4 : 1    |
|        +----------------------------+
|        | server_id         5 : 4    |
|        +----------------------------+
|        | event_length      9 : 4    |
+=====================================+
| event  | fixed part       13 : y    |
| data   +----------------------------+
|        | variable part              |
+=====================================+

标头长度 = 13 字节
数据长度 = (event_length - 13) 字节
y 特定于事件类型。
</code></pre></li><li><p>v3：在 MySQL 4.0.2 到 4.1 中使用</p><pre><code>+=====================================+
| event  | timestamp         0 : 4    |
| header +----------------------------+
|        | type_code         4 : 1    |
|        +----------------------------+
|        | server_id         5 : 4    |
|        +----------------------------+
|        | event_length      9 : 4    |
|        +----------------------------+
|        | next_position    13 : 4    |
|        +----------------------------+
|        | flags            17 : 2    |
+=====================================+
| event  | fixed part       19 : y    |
| data   +----------------------------+
|        | variable part              |
+=====================================+

标头长度 = 19 字节
数据长度 = (event_length - 19) 字节
y 特定于事件类型。
</code></pre></li><li><p>v4：用于 MySQL 5.0 及更高版本</p><pre><code>+=====================================+
| event  | timestamp         0 : 4    |
| header +----------------------------+
|        | type_code         4 : 1    |
|        +----------------------------+
|        | server_id         5 : 4    |
|        +----------------------------+
|        | event_length      9 : 4    |
|        +----------------------------+
|        | next_position    13 : 4    |
|        +----------------------------+
|        | flags            17 : 2    |
|        +----------------------------+
|        | extra_headers    19 : x-19 |
+=====================================+
| event  | fixed part        x : y    |
| data   +----------------------------+
|        | variable part              |
+=====================================+

标头长度 = x 字节
数据长度 = (event_length - x) 字节
固定数据长度 = y 字节可变数据长度 = (event_length - (x + y)) 字节
</code></pre></li></ul><h4 id=22-canal工作原理>2.2 canal工作原理</h4><ol><li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li><li>mysql master收到dump请求，开始推送binary log给slave(也就是canal)</li><li>canal解析binary log对象(原始为byte流)</li></ol><h4 id=23-canal架构>2.3 canal架构</h4><p><img src=./images/canal_construct.jfif alt></p><p>说明：</p><ul><li>server代表一个canal运行实例，对应于一个jvm</li><li>instance对应于一个数据队列 （1个server对应1..n个instance)</li></ul><p>instance模块：</p><ul><li><p>eventParser (数据源接入，模拟slave协议和master进行交互，协议解析)</p></li><li><p>eventSink (Parser和Store链接器，进行数据过滤，加工，分发的工作)</p></li><li><p>eventStore (数据存储)</p></li><li><p>metaManager (增量订阅&消费信息管理器)</p></li></ul><h5 id=canal-instance>canal-instance</h5><p>instance代表了一个实际运行的数据队列，包括了EventPaser,EventSink,EventStore等组件。</p><p>抽象了CanalInstanceGenerator，主要是考虑配置的管理方式：</p><ul><li>manager方式： 和你自己的内部web console/manager系统进行对接。(目前主要是公司内部使用)</li><li>spring方式：基于spring xml + properties进行定义，构建spring配置.</li></ul><p><img src=./images/canal_instance.jfif alt></p><h5 id=canal-event-parser>canal-event-parser</h5><p>整个parser过程大致可分为几步：</p><ol><li>Connection获取上一次解析成功的位置 (如果第一次启动，则获取初始指定的位置或者是当前数据库的binlog位点)</li><li>Connection建立链接，发送BINLOG_DUMP指令
// 0. write command number
// 1. write 4 bytes bin-log position to start at
// 2. write 2 bytes bin-log flags
// 3. write 4 bytes server id of the slave
// 4. write bin-log file name</li><li>Mysql开始推送Binaly Log</li><li>接收到的Binaly Log的通过Binlog parser进行协议解析，补充一些特定信息
// 补充字段名字，字段类型，主键信息，unsigned类型处理</li><li>传递给EventSink模块进行数据存储，是一个阻塞操作，直到存储成功</li><li>存储成功后，定时记录Binaly Log位置</li></ol><p><img src=./images/canal_parse.jfif alt></p><h5 id=canal-event-sink>canal-event-sink</h5><p><img src=./images/canal-sink.jfif alt></p><p>说明：</p><ul><li>数据过滤：支持通配符的过滤模式，表名，字段内容等</li><li>数据路由/分发：解决1:n (1个parser对应多个store的模式)</li><li>数据归并：解决n:1 (多个parser对应1个store)</li><li>数据加工：在进入store之前进行额外的处理，比如join</li></ul><blockquote><p>数据1:n业务</p></blockquote><blockquote><blockquote><p>为了合理的利用数据库资源， 一般常见的业务都是按照schema进行隔离，然后在mysql上层或者dao这一层面上，进行一个数据源路由，屏蔽数据库物理位置对开发的影响，阿里系主要是通过cobar/tddl来解决数据源路由问题。</p></blockquote></blockquote><blockquote><blockquote><p>所以，一般一个数据库实例上，会部署多个schema，每个schema会有由1个或者多个业务方关注</p></blockquote></blockquote><blockquote><p>数据n:1业务</p></blockquote><blockquote><blockquote><p>同样，当一个业务的数据规模达到一定的量级后，必然会涉及到水平拆分和垂直拆分的问题，针对这些拆分的数据需要处理时，就需要链接多个store进行处理，消费的位点就会变成多份，而且数据消费的进度无法得到尽可能有序的保证。</p></blockquote></blockquote><blockquote><blockquote><p>所以，在一定业务场景下，需要将拆分后的增量数据进行归并处理，比如按照时间戳/全局id进行排序归并.</p></blockquote></blockquote><h5 id=canal-event-store>canal-event-store</h5><ul><li>目前仅实现了Memory内存模式，后续计划增加本地file存储，mixed混合模式</li><li>借鉴了Disruptor的RingBuffer的实现思路</li></ul><p>RingBuffer设计：</p><p><img src=./images/cannal-store.jfif alt></p><p>定义了3个cursor</p><ul><li>Put : Sink模块进行数据存储的最后一次写入位置</li><li>Get : 数据订阅获取的最后一次提取位置</li><li>Ack : 数据消费成功的最后一次消费位置</li></ul><p>借鉴Disruptor的RingBuffer的实现，将RingBuffer拉直来看：
<img src=./images/cannal-store_1.jfif alt=img></p><p>实现说明：</p><ul><li>Put/Get/Ack cursor用于递增，采用long型存储</li><li>buffer的get操作，通过取余或者与操作。(与操作： cusor & (size - 1) , size需要为2的指数，效率比较高)</li></ul><h4 id=24-canal-ha设计>2.4 canal HA设计</h4><p><img src=./images/canal_ha.jfif alt></p><p>canal的ha分为两部分，canal server和canal client分别有对应的ha实现</p><ul><li>canal server: 为了减少对mysql dump的请求，不同server上的instance要求同一时间只能有一个处于running，其他的处于standby状态.</li><li>canal client: 为了保证有序性，一份instance同一时间只能由一个canal client进行get/ack/rollback操作，否则客户端接收无法保证有序。</li></ul><p>整个HA机制的控制主要是依赖了zookeeper的几个特性，watcher和EPHEMERAL节点(和session生命周期绑定)。</p><p>大致步骤：</p><ol><li>canal server要启动某个canal instance时都先向zookeeper进行一次尝试启动判断 (实现：创建EPHEMERAL节点，谁创建成功就允许谁启动)</li><li>创建zookeeper节点成功后，对应的canal server就启动对应的canal instance，没有创建成功的canal instance就会处于standby状态</li><li>一旦zookeeper发现canal server A创建的节点消失后，立即通知其他的canal server再次进行步骤1的操作，重新选出一个canal server启动instance.</li><li>canal client每次进行connect时，会首先向zookeeper询问当前是谁启动了canal instance，然后和其建立链接，一旦链接不可用，会重新尝试connect.</li></ol><p>Canal Client的方式和canal server方式类似，也是利用zookeeper的抢占EPHEMERAL节点的方式进行控制.</p><h4 id=25-canal-client>2.5 canal client</h4><h5 id=client-server交互>client-server交互</h5><p><img src=./images/canal-protobuf.jfif alt></p><p>get/ack/rollback协议介绍：</p><ul><li>Message getWithoutAck(int batchSize)，允许指定batchSize，一次可以获取多条，每次返回的对象为Message，包含的内容为：
a. batch id 唯一标识
b. entries 具体的数据对象，对应的数据对象格式：<a href=https://github.com/alibaba/canal/blob/master/protocol/src/main/java/com/alibaba/otter/canal/protocol/EntryProtocol.proto>EntryProtocol.proto</a></li><li>void rollback(long batchId)，顾命思议，回滚上次的get请求，重新获取数据。基于get获取的batchId进行提交，避免误操作</li><li>void ack(long batchId)，顾命思议，确认已经消费成功，通知server删除数据。基于get获取的batchId进行提交，避免误操作</li></ul><p>canal的get/ack/rollback协议和常规的jms协议有所不同，允许get/ack异步处理，比如可以连续调用get多次，后续异步按顺序提交ack/rollback，项目中称之为流式api.</p><p>流式api设计的好处：</p><ul><li>get/ack异步化，减少因ack带来的网络延迟和操作成本 (99%的状态都是处于正常状态，异常的rollback属于个别情况，没必要为个别的case牺牲整个性能)</li><li>get获取数据后，业务消费存在瓶颈或者需要多进程/多线程消费时，可以不停的轮询get数据，不停的往后发送任务，提高并行化. (作者在实际业务中的一个case：业务数据消费需要跨中美网络，所以一次操作基本在200ms以上，为了减少延迟，所以需要实施并行化)</li></ul><p>流式api设计：</p><p><img src=./images/canal-stream-api.jfif alt></p><ul><li>每次get操作都会在meta中产生一个mark，mark标记会递增，保证运行过程中mark的唯一性</li><li>每次的get操作，都会在上一次的mark操作记录的cursor继续往后取，如果mark不存在，则在last ack cursor继续往后取</li><li>进行ack时，需要按照mark的顺序进行数序ack，不能跳跃ack. ack会删除当前的mark标记，并将对应的mark位置更新为last ack cusor</li><li>一旦出现异常情况，客户端可发起rollback情况，重新置位：删除所有的mark, 清理get请求位置，下次请求会从last ack cursor继续往后取</li></ul><h5 id=数据对象格式>数据对象格式</h5><pre><code>Entry
	Header
		logfileName [binlog文件名]
		logfileOffset [binlog position]
		executeTime [binlog里记录变更发生的时间戳]
		schemaName [数据库实例]
		tableName [表名]
		eventType [insert/update/delete类型]
	entryType 	[事务头BEGIN/事务尾END/数据ROWDATA]
	storeValue 	[byte数据,可展开，对应的类型为RowChange]
	
	
RowChange
  isDdl		[是否是ddl变更操作，比如create table/drop table]
  sql		[具体的ddl sql]
  rowDatas	[具体insert/update/delete的变更数据，可为多条，1个binlog event事件可对应多条变更，比如批处理]
  beforeColumns [Column类型的数组]
  afterColumns [Column类型的数组]


Column
  index		[column序号]
  sqlType		[jdbc type]
  name		[column name]
  isKey		[是否为主键]
  updated		[是否发生过变更]
  isNull		[值是否为null]
  value		[具体的内容，注意为文本]
</code></pre><p>说明：</p><ul><li>可以提供数据库变更前和变更后的字段内容，针对binlog中没有的name,isKey等信息进行补全</li><li>可以提供ddl的变更语句</li></ul><h3 id=3cannel-源码>3.cannel 源码</h3><h4 id=31-canal启动>3.1 canal启动</h4><pre><code>public void start() {
        super.start();

        if (!embeddedServer.isStart()) {
            embeddedServer.start();
        }
        //1.创建canal server
        this.bootstrap = new ServerBootstrap(new NioServerSocketChannelFactory(Executors.newCachedThreadPool(),
            Executors.newCachedThreadPool()));
        bootstrap.setOption(&quot;child.keepAlive&quot;, true);
        bootstrap.setOption(&quot;child.tcpNoDelay&quot;, true);

        //2.构造对应的pipeline
        bootstrap.setPipelineFactory(() -&gt; {
            ChannelPipeline pipelines = Channels.pipeline();
            pipelines.addLast(FixedHeaderFrameDecoder.class.getName(), new FixedHeaderFrameDecoder());
            // support to maintain child socket channel.
            pipelines.addLast(HandshakeInitializationHandler.class.getName(),
                new HandshakeInitializationHandler(childGroups));
            pipelines.addLast(ClientAuthenticationHandler.class.getName(),
                new ClientAuthenticationHandler(embeddedServer));
            //会话处理
            SessionHandler sessionHandler = new SessionHandler(embeddedServer);
            pipelines.addLast(SessionHandler.class.getName(), sessionHandler);
            return pipelines;
        });

        //3.启动 默认监听1111端口
        if (StringUtils.isNotEmpty(ip)) {
            this.serverChannel = bootstrap.bind(new InetSocketAddress(this.ip, this.port));
        } else {
            this.serverChannel = bootstrap.bind(new InetSocketAddress(this.port));
        }
    }
</code></pre><pre><code>  public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {
        ChannelBuffer buffer = (ChannelBuffer) e.getMessage();
        Packet packet = Packet.parseFrom(buffer.readBytes(buffer.readableBytes()).array());
        ClientIdentity clientIdentity = null;
       
            switch (packet.getType()) {
                case SUBSCRIPTION:
                    
                    break;
                case UNSUBSCRIPTION:
                     
                    break;
                case GET:
                    
                    break;
                case CLIENTACK:
                
                    break;
                case CLIENTROLLBACK:
                     
                    break;
                default:
                   
                    break;
            }
    }
</code></pre><h4 id=32-client代码>3.2 client代码</h4><p><img src=./images/client_src.png alt></p><h5 id=321-订阅数据-socket>3.2.1 订阅数据-socket</h5><pre><code>public static void main(String args[]) {
    // 创建链接
    CanalConnector connector = CanalConnectors.newSingleConnector(new InetSocketAddress(AddressUtils.getHostIp(),11111), &quot;example&quot;, &quot;&quot;, &quot;&quot;);
    int batchSize = 1000; 
    try {
        connector.connect();
        connector.subscribe(&quot;.*\\..*&quot;);
        connector.rollback(); 
        while (isRunning) {
             // 获取指定数量的数据
            Message message = connector.getWithoutAck(batchSize);
            long batchId = message.getId();
            int size = message.getEntries().size();
            if(size &gt; 0){
              printEntry(batchId,message.getEntries());
            }
            // 提交确认
            connector.ack(batchId); 
            // 处理失败, 回滚数据
            // connector.rollback(batchId); 
        }
    } finally {
        connector.disconnect();
    }
}

private static void printEntry(long batchId,List&lt;Entry&gt; entrys) {
    for (Entry entry : entrys) {
        if (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) {
            continue;
        }
        //数据反序列化
        RowChange  rowChage = RowChange.parseFrom(entry.getStoreValue());
        EventType eventType = rowChage.getEventType();
        for (RowData rowData : rowChage.getRowDatasList()) {
            if (eventType == EventType.DELETE) {
                printColumn(rowData.getBeforeColumnsList());
            } else if (eventType == EventType.INSERT) {
                printColumn(rowData.getAfterColumnsList());
            } else {
                System.out.println(&quot;-------&amp;gt; before&quot;);
                printColumn(rowData.getBeforeColumnsList());
                System.out.println(&quot;-------&amp;gt; after&quot;);
                printColumn(rowData.getAfterColumnsList());
            }
        }
    }
}

private static void printColumn(List&lt;Column&gt; columns) {
    for (Column column : columns) {
        System.out.println(column.getName() + &quot; : &quot; + column.getValue() + &quot;    update=&quot; + column.getUpdated());
    }
}
</code></pre><h5 id=322-连接canal-server>3.2.2 连接canal server</h5><pre><code>private InetSocketAddress doConnect() throws CanalClientException {
        try {
            channel = SocketChannel.open();
            channel.socket().setSoTimeout(soTimeout);
            SocketAddress address = getAddress();
            if (address == null) {
                address = getNextAddress();
            }
            //1.连接 server
            channel.connect(address);
            //读channel
            readableChannel = Channels.newChannel(channel.socket().getInputStream());
            //写channel
            writableChannel = Channels.newChannel(channel.socket().getOutputStream());
            //2.握手
            Packet p = Packet.parseFrom(readNextPacket());
            if (p.getVersion() != 1) {
                throw new CanalClientException(&quot;unsupported version at this client.&quot;);
            }

            if (p.getType() != PacketType.HANDSHAKE) {
                throw new CanalClientException(&quot;expect handshake but found other type.&quot;);
            }
            Handshake handshake = Handshake.parseFrom(p.getBody());
            supportedCompressions.add(handshake.getSupportedCompressions());
            //
            ByteString seed = handshake.getSeeds(); // seed for auth
            String newPasswd = password;
            if (password != null) {
                // encode passwd
                newPasswd = SecurityUtil.byte2HexStr(SecurityUtil.scramble411(password.getBytes(), seed.toByteArray()));
            }

            ClientAuth ca = ClientAuth.newBuilder()
                .setUsername(username != null ? username : &quot;&quot;)
                .setPassword(ByteString.copyFromUtf8(newPasswd != null ? newPasswd : &quot;&quot;))
                .setNetReadTimeout(idleTimeout)
                .setNetWriteTimeout(idleTimeout)
                .build();
            //3.鉴权客户端
            writeWithHeader(Packet.newBuilder()
                .setType(PacketType.CLIENTAUTHENTICATION)
                .setBody(ca.toByteString())
                .build()
                .toByteArray());
            //4.连接成确认
            Packet ack = Packet.parseFrom(readNextPacket());
            if (ack.getType() != PacketType.ACK) {
                throw new CanalClientException(&quot;unexpected packet type when ack is expected&quot;);
            }

            Ack ackBody = Ack.parseFrom(ack.getBody());
            if (ackBody.getErrorCode() &gt; 0) {
                throw new CanalClientException(&quot;something goes wrong when doing authentication: &quot;
                                               + ackBody.getErrorMessage());
            }

            connected = true;
            return new InetSocketAddress(channel.socket().getLocalAddress(), channel.socket().getLocalPort());
        } catch (IOException | NoSuchAlgorithmException e) {
            throw new CanalClientException(e);
        }
    }
</code></pre><footer><section class=categories-tags><span><svg class="icon icon-folder"><use xlink:href="#icon-folder"/></svg><span class=screen-reader-text>This entry was posted in</span>
<a href=/categories/java>java</a></span> <span><svg class="icon icon-tag"><use xlink:href="#icon-tag"/></svg><a class=article-tags href=/tags/canal>canal</a></span></section></footer><div id=comments-button-container class=comments-button-container><button type=button onclick=loadDisqus() class=comments-button><svg class="icon icon-bubble"><use xlink:href="#icon-bubble"/></svg> <span>Show Comments</span></button></div><div id=disqus_thread></div><script type=text/javascript>function loadDisqus(){var a,b;document.getElementById('comments-button-container').style.display='none',a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='李明梓',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)}</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><aside id=sidebar><div class=widget><div class=widget-title>Recent posts</div><ol class="recent-widget widget-content"><li><a href=/%E4%BD%8D%E8%BF%90%E7%AE%97%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/>位运算基础知识</a></li><li><a href=/go-36%E8%AE%B2/>GO 36讲</a></li><li><a href=/maven-wrapper%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/>maven-wrapper基础使用</a></li><li><a href=/mysql-master-slave/>mysql master-slave</a></li><li><a href=/sonarqube%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/>sonarqube基础使用</a></li></ol></div><div class=widget><div class=widget-title>Categories</div><ol class="all-categories widget-content"><li><a href=/categories/devops>devops</a> (1)</li><li><a href=/categories/java>java</a> (4)</li><li><a href=/categories/mysql>mysql</a> (1)</li><li><a href=/categories/%E5%85%B6%E4%BB%96>其他</a> (4)</li><li><a href=/categories/%E5%89%8D%E7%AB%AF>前端</a> (1)</li><li><a href=/categories/%E5%90%8E%E7%AB%AF>后端</a> (1)</li><li><a href=/categories/%E5%9F%BA%E7%A1%80>基础</a> (1)</li><li><a href=/categories/%E5%B7%A5%E5%85%B7>工具</a> (2)</li></ol></div><div class=widget><div class=widget-title>Tags</div><div class="tag-cloud-tags widget-content"><a href=/tags/canal aria-label="canal (2 posts)" style=font-size:1rem>canal</a>
<a href=/tags/git aria-label="git (1 posts)" style=font-size:1rem>git</a>
<a href=/tags/go aria-label="go (1 posts)" style=font-size:1rem>go</a>
<a href=/tags/hexo aria-label="hexo (1 posts)" style=font-size:1rem>hexo</a>
<a href=/tags/java aria-label="java (1 posts)" style=font-size:1rem>java</a>
<a href=/tags/maven aria-label="maven (1 posts)" style=font-size:1rem>maven</a>
<a href=/tags/mysql aria-label="mysql (1 posts)" style=font-size:1rem>mysql</a>
<a href=/tags/yarn aria-label="yarn (1 posts)" style=font-size:1rem>yarn</a>
<a href=/tags/zabbix aria-label="zabbix (1 posts)" style=font-size:1rem>zabbix</a>
<a href=/tags/%E5%9F%BA%E7%A1%80 aria-label="基础 (1 posts)" style=font-size:1rem>基础</a>
<a href=/tags/%E5%B7%A5%E5%85%B7 aria-label="工具 (1 posts)" style=font-size:1rem>工具</a>
<a href=/tags/%E8%BD%AF%E6%96%87%E6%94%B6%E9%9B%86 aria-label="软文收集 (2 posts)" style=font-size:1rem>软文收集</a></div></div></aside></div></div><svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="icon-github" viewBox="0 0 32 32"><path d="M16 .395c-8.836.0-16 7.163-16 16 0 7.069 4.585 13.067 10.942 15.182.8.148 1.094-.347 1.094-.77.0-.381-.015-1.642-.022-2.979-4.452.968-5.391-1.888-5.391-1.888-.728-1.849-1.776-2.341-1.776-2.341-1.452-.993.11-.973.11-.973 1.606.113 2.452 1.649 2.452 1.649 1.427 2.446 3.743 1.739 4.656 1.33.143-1.034.558-1.74 1.016-2.14-3.554-.404-7.29-1.777-7.29-7.907.0-1.747.625-3.174 1.649-4.295-.166-.403-.714-2.03.155-4.234.0.0 1.344-.43 4.401 1.64 1.276-.355 2.645-.532 4.005-.539 1.359.006 2.729.184 4.008.539 3.054-2.07 4.395-1.64 4.395-1.64.871 2.204.323 3.831.157 4.234 1.026 1.12 1.647 2.548 1.647 4.295.0 6.145-3.743 7.498-7.306 7.895.574.497 1.085 1.47 1.085 2.963.0 2.141-.019 3.864-.019 4.391.0.426.288.925 1.099.768C27.421 29.457 32 23.462 32 16.395c0-8.837-7.164-16-16-16z"/></symbol><symbol id="icon-arrow-with-circle-up" viewBox="0 0 32 32"><path d="M16 .64C7.515.64.638 7.517.638 16c0 8.485 6.877 15.362 15.362 15.362 8.482.0 15.36-6.877 15.36-15.362.0-8.483-6.878-15.36-15.36-15.36zM15.998 28.16c-6.715.0-12.16-5.443-12.16-12.16S9.281 3.84 15.998 3.84 28.16 9.285 28.16 16s-5.446 12.16-12.162 12.16zM16 8.8l7.2 7.2h-4v6.4h-6.4V16h-4L16 8.8z"/></symbol></defs></svg><footer id=page-footer><div class=footer-content><a href=https://github.com/qiaomingzi/limz-blog-hugo target=_blank rel=noopener title="Source Code for this Blog"><div class=footer-text><svg class="icon icon-github"><use xlink:href="#icon-github"/></svg>Blog code</div></a><a href=#page-wrapper title="Go to top" id=go-to-top-link><div class=footer-text>To top<svg class="icon icon-arrow-with-circle-up"><use xlink:href="#icon-arrow-with-circle-up"/></svg></div></a><script>document.getElementById("go-to-top-link").onclick=function(){return window.scroll(0,0),!1}</script></div></footer></div><div id=lightbox-container :class="{'open': lightbox.isOpen, 'close': !lightbox.isOpen}"><button type=button aria-label="Close image modal" class=modal-close-button @click=lightbox.close()><svg class="icon icon-circle-with-cross"><use xlink:href="#icon-circle-with-cross"/></svg>
(ESC)</button><div id=lightbox-loading-container x-ref=lightboxLoadingContainer x-show=lightbox.showLoading><div id=lightbox-loading><div aria-busy=true aria-label="Loading, please wait." role=progressbar class=spinner @click=lightbox.cancel() @click.away=lightbox.cancel()></div></div></div><div id=lightbox x-ref=lightbox :class="{'open': lightbox.openImage, 'close': !lightbox.openImage}" @click=lightbox.close()></div></div><div id=code-container :class="{'open': code.isOpening, 'close': !code.isOpening}"><button class=modal-close-button><svg class="icon icon-circle-with-cross"><use xlink:href="#icon-circle-with-cross"/></svg>
(ESC)</button><div id=code-container-inner class=close :class="{'open': code.isOpening, 'close': !code.isOpening}"><div class=box-shadow-container @click.away=code.close()><div id=code-placeholder></div></div></div></div><div id=searchbox-container :class="{'open': search.isOpen}" x-show=search.isOpen x-on:keydown.escape="$nextTick(() => $refs.searchMenuLink.focus())"><button type=button aria-label="Close search modal" class=modal-close-button @click="search.close();$nextTick(() => $refs.searchMenuLink.focus())"><svg class="icon icon-circle-with-cross"><use xlink:href="#icon-circle-with-cross"/></svg>
(ESC)</button><div id=searchbox :class="{'open': search.isOpen}"><svg class="icon icon-search"><use xlink:href="#icon-search"/></svg><label for=search-input class=sr-only>Searchbox</label>
<input id=search-input type=search placeholder=Search... class=search-input x-ref=searchInput autocomplete=off autocorrect=off autocapitalize=off spellcheck=false x-model=search.textInSearchBox x-on:input=search.searchBoxChanged($event.target.value) x-on:keydown.enter="search.focusFirstAnchor($event, $refs.hits)" x-on:keydown.arrow-down="search.focusFirstAnchor($event, $refs.hits)"><svg class="icon icon-circle-with-cross close-search" role="button" aria-label="Close search" @click="search.close();$nextTick(() => $refs.searchMenuLink.focus())"><use xlink:href="#icon-circle-with-cross"/></svg></div><div class=search-results-container><div id=search-output x-show=search.textInSearchBox><div id=no-results-message x-show="search.store && search.textInSearchBox && !search.hits.length">No matching posts found. You can use wildcards and search only in titles, e.g. <code>title:iot</code></div><div id=index-loading-message x-show="!search.indexLoadFailed && search.indexLoading && search.textInSearchBox"><span class=icon-spinner aria-hidden=true></span>Loading search index, please wait...</div><div id=index-failed-message x-show="search.indexLoadFailed && search.textInSearchBox">Search index failed to download 😢</div><div id=number-of-hits-message x-text=search.getHitsText() x-show=search.hits.length></div><ol class=result-list x-show=search.hits.length x-ref=hits><template x-for="hit in search.hits" :key=hit.ref><li><h2><a :href=hit.ref x-text=search.fromStore(hit).title></a></h2><div class=entry-meta><time class=published :datetime=search.fromStore(hit).dateiso><svg class="icon icon-calendar"><use xlink:href="#icon-calendar"/></svg><span x-text=search.fromStore(hit).dateformatted></span></time></div><p x-text=search.fromStore(hit).summary></p></li></template></ol></div></div></div><script src=/bundle.326b2331e4a76c824b17b8d379095b25394912a8f7f1c8a6162a06f763a2caabe6226dee31773ec698c47b06f1de9bb7133091e9260d4d95b4011c7351300442.js integrity="sha512-MmsjMeSnbIJLF7jTeQlbJTlJEqj38cimFioG92OiyqvmIm3uMXc+xpjEewbx3pu3EzCR6SYNTZW0ARxzUTAEQg=="></script></body></html>